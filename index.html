<script>
  const backendURL = "https://gerador-ctr-backend.onrender.com/gerar";

  async function gerar() {
    const idsTexto = document.getElementById("ids").value;
    const ids = idsTexto.split(/[\n,;]+/).map(i => i.trim()).filter(Boolean);
    const statusDiv = document.getElementById("status");
    const road = document.querySelector(".road-container");
    const truck = document.getElementById("truck");
    const progressText = document.getElementById("progressText");
    const btn = document.getElementById("btnGerar");

    if (!ids.length) {
      alert("Insira pelo menos um ID.");
      return;
    }

    // Reset interface
    btn.disabled = true;
    statusDiv.textContent = `⏳ Processando ${ids.length} documentos...`;
    road.style.display = "block";
    truck.style.left = "0px";
    progressText.textContent = "0%";
    truck.classList.remove("dumping");

    const maxWidth = road.offsetWidth - truck.offsetWidth;
    let progressoGlobal = 0;

    // Dividir em lotes de 50 IDs
    const tamanhoLote = 50;
    const totalLotes = Math.ceil(ids.length / tamanhoLote);

    for (let i = 0; i < ids.length; i += tamanhoLote) {
      const lote = ids.slice(i, i + tamanhoLote);
      statusDiv.textContent = `⏳ Gerando lote ${Math.floor(i / tamanhoLote) + 1} de ${totalLotes}...`;

      try {
        const blob = await gerarLote(lote);

        // Download automático
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `Documentos_CTR_${lote[0]}-${lote[lote.length-1]}.zip`;
        a.click();

        // Atualiza progresso global
        progressoGlobal = Math.min(((i + lote.length) / ids.length) * 100, 100);
        truck.style.left = (maxWidth * (progressoGlobal / 100)) + "px";
        progressText.textContent = Math.floor(progressoGlobal) + "%";

      } catch (e) {
        statusDiv.textContent = `❌ Erro ao gerar lote: ${e}`;
        btn.disabled = false;
        return;
      }
    }

    // Ao final, 100% + animação da caçamba
    truck.style.left = maxWidth + "px";
    progressText.textContent = "100%";
    truck.classList.add("dumping");
    statusDiv.textContent = "✅ Todos os lotes foram gerados e baixados!";
    
    btn.disabled = false;
    setTimeout(() => {
      truck.classList.remove("dumping");
    }, 3500);
  }

  // Função que gera cada lote
  async function gerarLote(lote) {
    const resposta = await fetch(backendURL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ ids: lote })
    });

    if (!resposta.ok) throw new Error("Erro HTTP: " + resposta.status);
    const blob = await resposta.blob();
    if (blob.size === 0) throw new Error("ZIP vazio (nenhum PDF gerado)");

    return blob;
  }
</script>
