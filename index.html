<script>
  const backendURL = "https://gerador-ctr-backend.onrender.com";
  let session_id = crypto.randomUUID();
  let progressoTimer = null;

  async function gerar() {
    const idsTexto = document.getElementById("ids").value;
    const ids = idsTexto.split(/[\n,;]+/).map(i => i.trim()).filter(Boolean);
    const statusDiv = document.getElementById("status");
    const road = document.querySelector(".road-container");
    const truck = document.getElementById("truck");
    const progressText = document.getElementById("progressText");
    const btn = document.getElementById("btnGerar");

    if (!ids.length) {
      alert("Insira pelo menos um ID.");
      return;
    }

    btn.disabled = true;
    session_id = crypto.randomUUID();
    statusDiv.textContent = `⏳ Enviando ${ids.length} documentos em lotes...`;
    road.style.display = "block";
    truck.style.left = "0px";
    progressText.textContent = "0%";
    truck.classList.remove("dumping");

    const maxWidth = road.offsetWidth - truck.offsetWidth;
    const tamanhoLote = 50;

    // Inicia progresso real
    progressoTimer = setInterval(() => atualizarProgresso(ids.length, maxWidth), 500);

    // Envia lotes
    for (let i = 0; i < ids.length; i += tamanhoLote) {
      const lote = ids.slice(i, i + tamanhoLote);
      statusDiv.textContent = `⏳ Enviando lote ${Math.floor(i / tamanhoLote) + 1}...`;

      await fetch(backendURL + "/gerar-lote", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ ids: lote, session_id })
      });
    }

    clearInterval(progressoTimer); // para contador
    await atualizarProgresso(ids.length, maxWidth); // última atualização

    // Monta ZIP final
    statusDiv.textContent = "⏳ Montando ZIP final...";
    const resposta = await fetch(backendURL + "/finalizar", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ session_id })
    });

    if (!resposta.ok) {
      statusDiv.textContent = `❌ Erro ao gerar ZIP final: ${resposta.status}`;
      btn.disabled = false;
      return;
    }

    const blob = await resposta.blob();
    truck.style.left = maxWidth + "px";
    progressText.textContent = "100%";
    truck.classList.add("dumping");

    const url = window.URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "Documentos_CTR_Final.zip";
    a.click();

    statusDiv.textContent = "✅ Todos os PDFs foram gerados e baixados!";
    btn.disabled = false;
    setTimeout(() => truck.classList.remove("dumping"), 3500);
  }

  // Atualiza progresso real perguntando ao backend
  async function atualizarProgresso(totalIds, maxWidth) {
    const resp = await fetch(backendURL + "/progresso", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ session_id, total_ids: totalIds })
    });
    const data = await resp.json();
    const gerados = data.progresso;
    const total = data.total || totalIds;

    const perc = Math.floor((gerados / total) * 100);
    const truck = document.getElementById("truck");
    const progressText = document.getElementById("progressText");
    truck.style.left = (maxWidth * (perc / 100)) + "px";
    progressText.textContent = perc + "%";
  }
</script>
